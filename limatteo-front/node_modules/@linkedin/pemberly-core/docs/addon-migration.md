# Migration from gradle-pemberly for Pemberly Addon and JS Library

This guide is for migrating your pemberly addon or js-library from gradle-pemberly to `pemberly-core`.

### Install @linkedin/pemberly-core

```
just yarn add @linkedin/pemberly-core --dev
```

---

### Update product-spec.json

Previous `product-spec.json` should be like:

```
{
  ...,
  "build": {
    "commands": {
      ...,
      "build": "ligradle -Prelease=true -PallArtifacts build",
      ...,
    },
    ...,
  }
  ...
}
```

First you should make sure you have a `setup` command which should run `just init`.

* Change the `build` command from `ligradle -Prelease=true -PallArtifacts build` to `just yarn pack`
* If you have a `test` command that contains `ligradle npmTest`, change it to `just yarn test`
* If you have a `precommit` command that contains `ligradle jsPrecommit`, remove it

You don't need to touch other commands. Below is an example of the final state:

```
{
  ...,
  "build": {
    "commands": {
      ...,
      "build": "just yarn pack",
      "setup": "just init",
      "test": "just yarn test",
      ...,
    },
    ...,
  }
  ...
}
```

Due to our usage of `async` functions this requires your project to be on node version >=8. Make sure the node version list is >=8:

```
  ...,
  "versions": {
    ...,
    "node": "8.11.3",
    ...,
  }
  ...,
```

---

### Update package.json

In `package.json`, we need to add two npm script commands: `prepack` and `postpack`:

```
  ...,
  "scripts": {
    ...,
    "prepack": "pemberly-core prepack",
    "postpack": "pemberly-core postpack"
    ...,
  },
  ...
```

If you already have something defined in `prepack` or `postpack`, please combine your script with `pemberly-core` script using `&&`, and put `pemberly-core` script at the end of the script. For example:

```
  ...,
  "scripts": {
    ...,
    "prepack": "yourPrepackScript && pemberly-core prepack",
    "postpack": "yourPostpackScript && pemberly-core postpack"
    ...,
  },
  ...
```

If you are using `volta`, verify that the version defined is >=8:

```
  ...,
  "volta": {
    "node": "8.11.3",
    ...,
  }
  ...,
```

---

### Docin Support

If you have `docin` in your multiproduct, you need to add a new `doc` script in your `package.json` and change your `prepack` script to `just yarn doc && pemberly-core prepack`:

```
  ...,
  "scripts": {
    ...,
    "doc": "ligradle -Prelease=true -PallArtifacts docs:generateDocsTgz docs:ivyForArchives docs:generateModuleArtifactSpec",
    "prepack": "just yarn doc && pemberly-core prepack",
    "postpack": "pemberly-core postpack"
    ...,
  },
  ...
```

---

# How it works

In order to build a pemberly addon, we need to call `yarn pack` to generate the tarball, and publish the tarball to artifact. 


### pemberly-core prepack

Before running `yarn pack`, we need to do some preparation work in `prepack: pemberly-core prepack`:

1. Make sure we have the right file structure ready for the `build` directory.
2. Create a temp json file `build/pemberly-core/.meta.json` to store useful value during the build process.
3. Get the next available version of current multiproduct based on the version defined in `product-spec.json` and the version published in artifact.
4. Modify the version in `package.json` to the next available version.

### yarn pack

`yarn pack` will generate the tarball file in the root directory of your multiproduct. The name of the tarball is based on the `name` and `version` fields in `package.json`.

### pemberly-core postpack

After running `yarn pack`, we are doing the following to make sure our build is ready to publish:

1. Create `build/pemberly-core/publish/{mpName}-{version}.ivy` file.
2. Create `build/artifact-spec.json` and `build/module-artifact-spec.json`. If you have the command to build `docin` in `prepack` script, it will merge docin's `artifact-spec.json` to current multiproduct's `artifact-spec.json`.
3. Move the tarball from multiproduct's root to `build/pemberly-core/pubish/`.
4. Revert the version in `package.json` which we changed during `prepack`, to avoid any unnecessary file change.


