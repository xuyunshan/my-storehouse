# Migration from gradle-pemberly for Pemberly App

This guide is for migrating your pemberly app from gradle-pemberly to `pemberly-core.`  Greenfield `pemberly-core` documentation can be found [here][docs:pemberly-core]

## Overview

Moving from gradle-pemberly requires a few trival steps within `product-spec.json` and `package.json` and depending on the contents of your `build.gradle` file you may have other steps.

For a more detailed overview including how to co-locate the BPR visit: [go/the-migration](http://go/the-migration).

1. Within `product-spec.json` change `build.commands.build` to `just yarn build`
2. Within `package.json` change `scripts.build` to `pemberly-core build`
3. Within `package.json` add the following properties to the bottom:
```json
  "files": [
    "dist"
  ]
```
4. Install `pemberly-core` via: `just yarn add -D @linkedin/pemberly-core`

At this point run `mint build` and verify that the build has completed successfully.


## PDSCs / IDLs

Before pemberly-core these options were defined in `build.gradle` such as
```
dependencies {
  pdsc spec.product.'voyager-api'.'data-template',
    spec.product.'voyager-api'.'urns',
  idl spec.product.'voyager-api'.'api'
}
```

Simply migrate these definitions to `package.json` like so:

```json
{
  "pemberly": {
    "pdsc": ["voyager-api.data-template", "voyager-api.urns"],
    "idl": ["voyager-api.api"]
  }
}
```

## Spark Asset Hashing & Compression

Before pemberly-core these options were defined in `gradle.properties` such as:

```
updateScHashes.compressionContentEncodings=br,gzip
```

Simply migrate this definition to `package.json` like so:

```json
{
  "pemberly": {
    "sparkCompression": ["br", "gzip"],
  }
}
```

There are only 2 supported compression algorithms: brotli (br), and gzip (gzip).

## Migrate away from: EmberExecTask, NpmExecTask, and NodeExecTask

If you have tasks defined in `build.gradle` that extend from: `EmberExecTask,` `NpmExecTask`, or `NodeExecTask` those will need to be migrated off. In general these tasks can be easily translated into a npm scripts like the following example:

Say you have:

`product-spec.json`
```json
{
  "build": {
    "commands": {
      "gen-i18n": "ligradle generateI18n"
    }
  }
}
```

`build.gradle`
```gradle
task("generateI18n", type: EmberExecTask) {
    dependsOn("jsInit")
    emberCommand = "pemberly:i18n:extract"
}
```

This can be translated to:

`product-spec.json`
```json
{
  "build": {
    "commands": {
      "gen-i18n": "just yarn gen-i18n"
    }
  }
}
```

`package.json`
```json
{
  "scripts": {
    "gen-i18n": "just init && just ember pemberly:i18n:extract"
  }
}
```

For more examples, view voyager-web's migration: https://rb.corp.linkedin.com/r/1469614/

## Migrate away from jsPrecommit or pemberlyPrecommit

If you have `ligradle jsPrecommit` or `ligradle pemberlyPrecommit` defined in `product-spec.json` like:

```json
{
  "build": {
    "commands": {
      "precommit": "ligradle jsPrecommit"
    }
  }
}
```

this will need to be migrated. If you are using `jsPrecommit` you can simply remove all usages of it. jsPrecommit only gives us
two checks: ValidateNoClientDependencyOnNpm and productNameSyncCheck. productNameSyncCheck is not needed since we correctly setup the
names in product-spec & package.json during the creation workflow and ValidateNoClientDependencyOnNpm is not needed now that we are using yarn
and node-mp-bridge which keeps the deps in sync for us.

If you are using `pemberlyPrecommit` then you will need to migrate over to `ember-cli-template-lint`. `pemberlyPrecommit` provides `lintTemplates` which will check all `.hbs` files if they contain `{{{`. `ember-cli-template-lint` provides this check (plus way more). To migrate:

1. Install `ember-cli-template-lint` via `just ember install ember-cli-template-lint`
2. Add the following to `package.json`
```json
{
  "scripts": {
    "lint:hbs": "ember-template-lint ."
  }
}
```
3. If you have `hbsLintExclude` set in `gradle.properties` you will need to create `.template-lintrc.js` and add the ingored files there. For more information check out: [ember-template-lint](https://github.com/ember-template-lint/ember-template-lint)
4. Change `product-spec.json` to:
```json
{
  "build": {
    "commands": {
        "precommit": "ligradle jsInit && just yarn lint:hbs"
    }
  }
}
```

## Example Migration RBs

https://rb.corp.linkedin.com/r/1493136/


[docs:pemberly-core]: https://git.corp.linkedin.com:1367/plugins/gitiles/multiproducts/pemberly-core
