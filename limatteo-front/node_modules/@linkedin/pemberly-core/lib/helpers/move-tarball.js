const SilentError = require('silent-error');
const fs = require('fs-extra');
const path = require('path');
const globby = require('globby');

/**
 * After yarn pack, move the tarball to build folder
 *
 * @param {Object} productInfo
 * @return {Promise}
 */
async function moveTarball(productInfo) {
  const tarPaths = await globby(['linkedin-*.tgz'], { cwd: productInfo.root });

  if (tarPaths.length === 0) {
    throw new SilentError(
      `[post-pack]: Failed to find the tarball created during 'yarn pack'.`
    );
  }

  const tarballOriginPath = path.join(productInfo.root, tarPaths[0]);
  // here we use tarball filename without the letter "v" before version, as same as the one in artifact-spec and module-artifact-spec
  const tarballTargetPath = path.join(
    productInfo.publishDir,
    `linkedin-${productInfo.mpName}-${productInfo.nextVersion}.tgz`
  );

  try {
    await fs.move(tarballOriginPath, tarballTargetPath);
  } catch (e) {
    throw new SilentError(
      `[post-pack]: Failed to create Tarball in ${tarballTargetPath}`
    );
  }
}

module.exports = moveTarball;
