const execa = require('execa');
const fs = require('fs-extra');
const path = require('path');

/**
 * check if dependency-spec.json exists in build folder
 *
 * @param {String} buildDir build folder path
 * @returns {Boolean}
 */
async function isDependencySpecExisted(buildDir) {
  const existed = await fs.exists(path.join(buildDir, 'dependency-spec.json'));
  return existed;
}

/**
 * Generate dependency-spec.json in local env
 *
 */
async function generate() {
  try {
    await execa('mint', ['dependency', 'create-dependency-spec']);
  } catch (e) {
    throw e;
  }
}

/**
 * Get the next version in dependency-spec.json
 *
 * @param {*} buildDir
 * @returns
 */
async function getNextVersion(buildDir) {
  try {
    // check if dependency-spec.json exists
    const existed = await isDependencySpecExisted(buildDir);
    if (!existed) {
      await generate();
    }
    const dependencySpec = await fs.readJson(
      path.join(buildDir, 'dependency-spec.json')
    );
    return dependencySpec.version;
  } catch (e) {
    throw e;
  }
}

module.exports = getNextVersion;
