const SilentError = require('silent-error');
const fs = require('fs-extra');
const path = require('path');

/**
 * generate ivy files based on this XML template
 *
 * @param {Object} info product information
 * @returns {String} final ivy XML
 */
function ivyTemplate(info) {
  return `<?xml version="1.0" encoding="UTF-8"?> 
  <ivy-module version="2.0" xmlns:m="http://ant.apache.org/ivy/maven"> 
  <info organisation="${info.org}" module="${info.mpName}" revision="${info.nextVersion}" status="${info.status}" publication="${info.publication}"/> 
  <configurations> 
    <conf name="archives" visibility="public"/>
    <conf name="default" visibility="public"/>
    <conf name="gcc" visibility="public"/>
    <conf name="node" visibility="public"/>
    <conf name="yarn" visibility="public"/>
  </configurations> 
  <publications> 
    <artifact name="${info.artifactName}" type="${info.artifact_type}" ext="${info.ext}" conf="${info.conf}"/> 
  </publications> 
  <dependencies> 
    <dependency org="com.linkedin.gcc" name="gcc" rev="4.8.3.9" conf="gcc-&gt;default">
      <artifact name="gcc-linux-x64" type="tgz" ext="tgz" conf="gcc"/>
    </dependency>
    <dependency org="com.linkedin.nodejs" name="nodejs" rev="${info.versions.node}" transitive="false" conf="node-&gt;default">
      <artifact name="nodejs" type="tar.gz" ext="tar.gz" m:classifier="darwin-x64" conf="node"/>
    </dependency>
    <dependency org="" name="yarn" rev="${info.versions.yarn}" transitive="false" conf="yarn-&gt;default">
      <artifact name="yarn" type="tgz" ext="tgz" conf="yarn"/>
    </dependency>
  </dependencies> 
  </ivy-module>`;
}

/**
 * Create ivy file in to target dir, then create link in the root dir
 *
 * @param {Object} productInfo product information
 * @returns {Promise}
 */
async function createIvy(productInfo) {
  try {
    const ivy = ivyTemplate(productInfo);
    await fs.writeFile(
      path.join(
        productInfo.publishDir,
        `${productInfo.mpName}-${productInfo.nextVersion}.ivy`
      ),
      ivy,
      'utf-8'
    );
  } catch (e) {
    throw new SilentError(`[post-pack]: Failed to create IVY file.`);
  }
}

module.exports = createIvy;
