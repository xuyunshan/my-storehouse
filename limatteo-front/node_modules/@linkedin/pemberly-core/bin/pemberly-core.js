#!/usr/bin/env node
const UI = require('console-ui');

/*
 * This is the entry binary for pemberly-core. The imports / requires in this
 * file should not change inorder to preserve backwards compatiblity during
 * dependency testing.
 */
(async () => {
  let { stdin, stdout, stderr, env, argv } = process;
  let [, , commandName] = argv;
  let ui = new UI({
    inputStream: stdin,
    outputStream: stdout,
    errorStream: stderr,
    ci: env.CI,
  });

  try {
    let mpLocation = process.cwd();
    let { ORG_GRADLE_PROJECT_resolveHighest: dependency } = env;

    // run dependency install for both build and prepack command
    if (dependency && (commandName === 'build' || commandName === 'prepack')) {
      let DependencyInstall = require('../lib/dependency-install');
      let dependencyInstall = new DependencyInstall({
        mpLocation,
        dependency,
        ui,
      });
      await dependencyInstall.run();
    }

    let CLI = require('../lib/cli');
    let cliTasks = new CLI({ mpLocation, ui, env, commandName });

    await cliTasks.run();
  } catch (error) {
    let errorToLog = error.stderr ? error.stderr : error;
    let errorCode = error.code ? error.code : 1;
    ui.writeError(errorToLog);

    process.exit(errorCode);
  }
})();
