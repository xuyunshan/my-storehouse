# Pemberly Core

Pemberly core is a collection of npm tasks that are necessary for pemberly-web multiproducts to successfully build. The goal of this project is to migrate all of the "js concerned" tasks out of gradle-pemberly and into node land. By doing so we are bringing our js developement workflow closer to standard open source best practices, enabling first class debugging with tools such as ndb or node --inspect-brk, and producing saner logs. Other goals such as working local deployments and performance improvements are now possible.

## Installation

```
just yarn add @linkedin/pemberly-core
```

## Usage

Pemberly-core provides an executable called `pemberly-core` which can be invoked via: `./node_modules/.bin/pemberly-core <COMMAND_NAME>` (available commands are listed below). However, you
should call the executable via yarn scripts like: `just yarn build`. To do that simply add (or change)
the property called `scripts` and add a sub `build` property to that with the value: `pemberly-core build` in `package.json` of your pemberly-web multiproducts. This will then trigger `pemberly-core build` anytime you run `just yarn build`.

Example `package.json`:

```json
{
  ...,
  "scripts": {
    "build": "pemberly-core build"
  },
  ...
}
```

### Commands

- `build`: Triggers a build
- `snapshot`: Runs the build with snapshot as an extra argument.
- `pdsc-download`: Runs the pdsc-download task which downloads API metadata (PDSCs, IDLs, and microschemas) to `build/ember-cli-pdsc-handler` or the specified directory that's configured using the `downloadDir` configuration option.

### Configuration options

All configurations are done within `package.json` and within the `pemberly` property. Example:

```json
{
  "name": "my-example-app",

  "pemberly": {
    "downloadDir": "build/ember-restli-api-metadata",
    "pdsc": ["voyager-api.data-template", "voyager-api.urns"],
    "idl": ["voyager-api.api"],
    "sparkCompression": ["br", "gzip"],
    "l10n": {
      "should-fail-build": false
    }
  }
}
```

**NOTE**: The above options are all optional.

#### API Metadata

Pemberly APIs produce three kinds of metadata: PDSCs for their data models, IDLs for describing Rest.li resources, and microschemas (currently obtained from locations of PDSC artifacts). Configure the metadata you need to use in your app at `pemberly.pdsc` and `pemberly.idl` within `package.json`, as well as within `product` of `product-spec.json`.

For example:

```js
// package.json
{
  "pemberly": {
    "pdsc": ["voyager-api.data-template"],
    "idl": ["voyager-api.api"]
  }
}

// product-spec.json

{
  "product": {
    "voyager-api": {
      "libraries": [
        {
          "configuration": "dataTemplate",
          "name": "data-template"
        },
        {
          "configuration": "restModel",
          "name": "api"
        }
      ],
      "version": 0.599.68
    }
  }
}
```

You can find the list of libraries for a multiproduct on artifactory. For example, voyager-api's are listed [here][voyager-api:artifactory].

Check with your API engineers for which libraries contain IDLs and which contain PDSCs.

You can verify that your configuration here is correct by building your app and then verifying your PDSCs and IDLs exist in a generated `build` directory

```sh
find build -iname '*.pdsc' -or -iname '*.restspec.json'

# PDSCs
# build/ember-cli-pdsc-handler/video-lib-common/data-template/0.3.41/pegasus/com/linkedin/videocontent/VideoPlayMetadata.pdsc
# build/ember-cli-pdsc-handler/video-lib-common/data-template/0.3.41/pegasus/com/linkedin/videocontent/ProgressiveDownloadMetadata.pdsc
# build/ember-cli-pdsc-handler/video-lib-common/data-template/0.3.41/pegasus/com/linkedin/videocontent/AdaptiveStreamProtocol.pdsc
# ...
# IDLs
# build/ember-cli-pdsc-handler/voyager-api/api/0.595.10/com.linkedin.voyager.growth.voyagerGrowthContactsFiltering.restspec.json
# build/ember-cli-pdsc-handler/voyager-api/api/0.595.10/com.linkedin.voyager.jobs.voyagerJobsJobsBadge.restspec.json
# build/ember-cli-pdsc-handler/voyager-api/api/0.595.10/com.linkedin.voyager.organization.voyagerOrganizationContentRevisions.restspec.json
# ...
```

#### Spark Asset Hashing & Compression

Configure the compression algorithms used at `pemberly.sparkCompression`.

For example:

```json
{
  "pemberly": {
    "sparkCompression": ["br", "gzip"]
  }
}
```

There are only 2 supported compression algorithms: brotli (br), and gzip (gzip).

## Additional Resources

- [Pemberly App Migration guide from gradle-pemberly][app migration guide]
- [Pemberly Addon / JS Library Migration guide from gradle-pemberly][addon migration guide]
- [Downloading API Metadata in gradle-pemberly][legacy guide]

[voyager-api:artifactory]: http://artifactory.corp.linkedin.com:8081/artifactory/release/com/linkedin/voyager-api/
[app migration guide]: ./docs/app-migration.md
[addon migration guide]: ./docs/addon-migration.md
[legacy guide]: ./docs/gradle-pemberly.md
